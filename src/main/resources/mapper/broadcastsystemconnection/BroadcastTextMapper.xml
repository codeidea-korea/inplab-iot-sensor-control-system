<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.safeone.dashboard.dao.broadcastsystemconnection.BroadcastTextMapper">
    <sql id="rowSearch">
        <if test="mgnt_no != null and mgnt_no != ''">
            and tbn.mgnt_no::TEXT ilike '%' || #{mgnt_no} || '%'
        </if>
        <if test="brdcast_title != null and brdcast_title != ''">
            and tbn.brdcast_title ilike '%' || #{brdcast_title} || '%'
        </if>
        <if test="brdcast_msg_dtls != null and brdcast_msg_dtls != ''">
            and tbn.brdcast_msg_dtls ilike '%' || #{brdcast_msg_dtls} || '%'
        </if>
    </sql>

    <sql id="rowOrder">
        <trim prefix="order by">
            <choose>
                <when test="'mgnt_no' == sidx and sidx != ''">
                    tbn.mgnt_no ${sord}
                </when>
                <when test="'brdcast_title' == sidx and sidx != ''">
                    tbn.brdcast_title ${sord}
                </when>
                <when test="'brdcast_msg_dtls' == sidx and sidx != ''">
                    tbn.brdcast_msg_dtls ${sord}
                </when>
                <otherwise>
                    tbn.reg_dt desc
                </otherwise>
            </choose>
        </trim>
    </sql>

    <select id="selectBroadcastInfoList"
            resultType="com.safeone.dashboard.dto.broadcastsystemconnection.BroadcastInfoDto">
        SELECT tbi.brdcast_no
             , tbi.brdcast_nm
        FROM tb_broadcast_info tbi
    </select>

    <select id="selectBroadcastTextList" parameterType="java.util.Map"
            resultType="com.safeone.dashboard.dto.broadcastsystemconnection.BroadcastTextDto">
        SELECT tbn.mgnt_no
        , tbn.brdcast_title
        , tbn.brdcast_msg_dtls
        FROM tb_broadcast_notice tbn
        WHERE 1=1
        <include refid="rowSearch"/>
        <include refid="rowOrder"/>
        <if test="page != null and page > 0">
            limit #{rows}::int offset (#{page}::int - 1) * #{rows}::int
        </if>
    </select>

    <select id="selectBroadcastTextListTotal" parameterType="java.util.Map" resultType="int">
        SELECT count(tbn.mgnt_no)
        FROM tb_broadcast_notice tbn
        WHERE 1 = 1
        <include refid="rowSearch"/>
    </select>

    <insert id="insertBroadcastText" parameterType="java.util.Map">
        INSERT INTO tb_broadcast_notice ( mgnt_no
                                        , brdcast_title
                                        , brdcast_msg_dtls
                                        , reg_dt
                                        , mod_dt)
        SELECT COALESCE(max(mgnt_no::integer), 0) + 1 as mgnt_no
             , #{brdcast_title}
             , #{brdcast_msg_dtls}
             , now()
             , now()
        FROM tb_broadcast_notice
    </insert>

    <update id="updateBroadcastText" parameterType="java.util.Map">
        UPDATE tb_broadcast_notice
        SET brdcast_msg_dtls = #{brdcast_msg_dtls}
          , brdcast_title    = #{brdcast_title}
          , mod_dt           = now()
        WHERE mgnt_no = #{mgnt_no}
    </update>

    <delete id="deleteBroadcastText" parameterType="java.util.Map">
        DELETE
        FROM tb_broadcast_notice
        WHERE mgnt_no = #{mgnt_no}
    </delete>

    <select id="selectBroadcastNoticeOptions" resultType="java.util.HashMap">
        SELECT tbn.mgnt_no
             , tbn.brdcast_title
             , tbn.brdcast_msg_dtls
        FROM tb_broadcast_notice tbn
        ORDER BY tbn.reg_dt DESC, tbn.mgnt_no DESC
    </select>

    <select id="selectDistrictOptions" resultType="java.util.HashMap">
        SELECT tdi.district_no
             , tdi.district_nm
        FROM tb_district_info tdi
        ORDER BY tdi.district_nm
    </select>

    <select id="selectBroadcastEquipOptions" resultType="java.util.HashMap">
        SELECT tbi.brdcast_no
             , tbi.brdcast_nm
             , tbi.district_no
        FROM tb_broadcast_info tbi
        WHERE COALESCE(tbi.del_yn, 'N') = 'N'
        ORDER BY tbi.brdcast_nm
    </select>
</mapper>
