<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.safeone.dashboard.dao.SensorGroupingMapper">
    <sql id="timeBucketExpr">
        <choose>
            <when test="selectType != null and selectType == 'hour'">
                DATE_TRUNC('hour', tmd.meas_dt)
            </when>
            <when test="selectType != null and selectType == 'day'">
                DATE_TRUNC('day', tmd.meas_dt)
            </when>
            <when test="selectType != null and selectType == 'week'">
                DATE_TRUNC('week', tmd.meas_dt)
            </when>
            <when test="selectType != null and selectType == 'month'">
                DATE_TRUNC('month', tmd.meas_dt)
            </when>
            <otherwise>
                DATE_TRUNC('minute', tmd.meas_dt)
            </otherwise>
        </choose>
    </sql>

    <sql id="chartInitBaseExpr">
        <choose>
            <when test="init_base != null and init_base == 'raw'">
                COALESCE(tsit.init_raw_data, 0)
            </when>
            <otherwise>
                COALESCE(tsit.formul_data, 0)
            </otherwise>
        </choose>
    </sql>

    <sql id="rowSearch">
        <if test="sens_nm != null and sens_nm != ''">
            and tsinfo.sens_nm ilike '%' || #{sens_nm} || '%'
        </if>
        <if test="sens_tp_nm != null and sens_tp_nm != ''">
            and tst.sens_tp_nm ilike '%' || #{sens_tp_nm} || '%'
        </if>
        <if test="last_apply_dt_start != null and last_apply_dt_start != '' and last_apply_dt_end != null and last_apply_dt_end != ''">
            and tsi.last_apply_dt::timestamp between concat(#{last_apply_dt_start},' 00:00:00')::timestamp and
            concat(#{last_apply_dt_end},' 23:59:59')::timestamp
        </if>
        <if test="maint_sts_cd != null and maint_sts_cd != ''">
            and tsinfo.maint_sts_cd ilike '%' || #{maint_sts_cd} || '%'
        </if>
    </sql>

    <sql id="rowOrder">
        <trim prefix="order by">
            <choose>
                <when test="'sens_nm' == sidx and sidx != ''">
                    tsinfo.sens_nm ${sord}
                </when>
                <when test="'sens_tp_nm' == sidx and sidx != ''">
                    MAX(tst.sens_tp_nm) ${sord}
                </when>
                <when test="'last_apply_dt' == sidx and sidx != ''">
                    last_apply_dt ${sord}
                </when>
                <when test="'maint_sts_cd' == sidx and sidx != ''">
                    tsinfo.maint_sts_cd ${sord}
                </when>
                <otherwise>
                    senstype_no, sens_nm
                </otherwise>
            </choose>
        </trim>
    </sql>

    <select id="selectList" parameterType="java.util.Map"
            resultType="com.safeone.dashboard.dto.SensorGroupingDto">
        SELECT
            tsinfo.sens_nm,
            MAX(tst.sens_tp_nm) AS sens_tp_nm,
            MAX(tsi.formul_data) AS formul_data,
            MIN(tsi.init_apply_dt) AS init_apply_dt,
            MAX(tsi.last_apply_dt) AS last_apply_dt,
            MAX(tsi.emer_status) AS emer_status,
            tsinfo.sens_no,
            tsinfo.maint_sts_cd,
            MAX(tsi.sens_chnl_id) AS sens_chnl_id,
            tsinfo.senstype_no AS senstype_no,
            CASE
            WHEN COALESCE(lmd.err_cnt, 999999) >= tsinfo.nonrecv_limit_min THEN '미수신'
            ELSE '수신'
            END AS comm_status
        FROM tb_sensor_info tsinfo
        LEFT JOIN tb_sensor_init tsi
        ON tsinfo.sens_no = tsi.sens_no
        LEFT JOIN tb_sensor_type tst
        ON tsinfo.senstype_no = tst.senstype_no
        LEFT JOIN (
            SELECT m.sens_no,
            MAX(m.sens_chnl_id) AS sens_chnl_id,
            MAX(m.meas_dt) AS meas_dt,
            EXTRACT(EPOCH FROM (now() - MAX(m.meas_dt))) / 60 AS diff_min,
            EXTRACT(EPOCH FROM (now() - MAX(m.meas_dt))) / 60 - 1 AS err_cnt
            FROM tb_measure_details m
            GROUP BY m.sens_no
        ) AS lmd ON lmd.sens_no = tsinfo.sens_no
        WHERE 1 = 1
        <include refid="rowSearch"/>
        AND tsinfo.sens_no IN (
            SELECT tlim.sens_no
            FROM tb_logr_idx_map tlim
            WHERE tlim.logr_no IN (
                SELECT tli.logr_no
                FROM tb_district_info tdi
                LEFT JOIN tb_logger_info tli ON tli.district_no = tdi.district_no
                WHERE tdi.district_no = #{district_no}
            )
        )
        GROUP BY
            tsinfo.sens_nm,
            tsinfo.sens_no,
            tsinfo.nonrecv_limit_min,
            lmd.err_cnt
        <include refid="rowOrder"/>
        <if test="page != null and page > 0">
            limit #{rows}::int offset (#{page}::int - 1) * #{rows}::int
        </if>
    </select>

    <select id="selectListTotal" parameterType="java.util.Map" resultType="int">
        select count(c.*) from (select tsinfo.*
        FROM tb_sensor_info tsinfo
        LEFT JOIN tb_sensor_init tsi
        ON tsinfo.sens_no = tsi.sens_no
        LEFT JOIN tb_sensor_type tst
        ON tsinfo.senstype_no = tst.senstype_no
        WHERE 1 = 1
        <include refid="rowSearch"/>
        and tsinfo.sens_no IN (SELECT tlim.sens_no
        FROM tb_logr_idx_map tlim
        WHERE tlim.logr_no IN (SELECT tli.logr_no
        FROM tb_district_info tdi
        LEFT JOIN tb_logger_info tli
        ON tli.district_no = tdi.district_no
        WHERE tdi.district_no = #{district_no}))
        GROUP BY tsinfo.sens_nm, tsinfo.sens_no) as c
    </select>

    <select id="selectSensorChartData" parameterType="java.util.Map"
            resultType="com.safeone.dashboard.dto.SensorChartDto">
        SELECT
            tmd.sens_no,
            tsi.sens_nm,
            tmd.sens_chnl_id,
            tsi.senstype_no,
            max(tmd.formul_data - <include refid="chartInitBaseExpr"/>) as max_data,
            min(tmd.formul_data - <include refid="chartInitBaseExpr"/>) as min_data,
            AVG(tmd.formul_data - <include refid="chartInitBaseExpr"/>) AS formul_data,
            <include refid="timeBucketExpr"/> AS meas_dt,
            MAX(tai."1st_lvl_min") AS lvl_min1,
            MAX(tai."2nd_lvl_min") AS lvl_min2,
            MAX(tai."3rd_lvl_min") AS lvl_min3,
            MAX(tai."4th_lvl_min") AS lvl_min4,
            MAX(tai."1st_lvl_max") AS lvl_max1,
            MAX(tai."2nd_lvl_max") AS lvl_max2,
            MAX(tai."3rd_lvl_max") AS lvl_max3,
            MAX(tai."4th_lvl_max") AS lvl_max4
        FROM tb_measure_details tmd
                 LEFT JOIN tb_alarm_info tai
                           ON tai.sens_no = tmd.sens_no
                               AND COALESCE(tai.sens_chnl_id, '') = COALESCE(tmd.sens_chnl_id, '')
                 LEFT JOIN tb_sensor_info tsi
                           ON tmd.sens_no = tsi.sens_no
                 LEFT JOIN tb_sensor_init tsit
                           ON tsit.sens_no = tmd.sens_no
                               AND COALESCE(tsit.sens_chnl_id, '') = COALESCE(tmd.sens_chnl_id, '')
        WHERE tmd.meas_dt BETWEEN (#{start_date_time}::timestamp) AND (#{end_date_time}::timestamp)
          AND tmd.sens_no = #{sens_no}
        <if test="sens_chnl_id != null and sens_chnl_id != ''">
            AND tmd.sens_chnl_id = #{sens_chnl_id}
        </if>
        GROUP BY tmd.sens_no, tsi.sens_nm, tmd.sens_chnl_id, tsi.senstype_no, <include refid="timeBucketExpr"/>
        ORDER BY <include refid="timeBucketExpr"/>
    </select>
</mapper>
